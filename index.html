<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#f6f3ee" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Invitación | Tihare & Christopher</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div id="msg"></div>

  <audio id="bgm" src="musica.mp3" loop muted playsinline preload="auto"></audio>
  <div id="book" aria-label="Libro"></div>
  <div id="tap-left"  class="tap-zone" aria-hidden="true"></div>
  <div id="tap-right" class="tap-zone" aria-hidden="true"></div>

  <div id="fallback" aria-hidden="true">
    <div class="strip">
      <img src="page1.png" alt="Página 1">
      <img src="page2.png" alt="Página 2">
      <img src="page3.png" alt="Página 3">
      <img src="page4.png" alt="Página 4">
    </div>
  </div>

  <script src="libs/page-flip.browser.min.js"></script>

  <script>
  (function () {
    const bgm = document.getElementById('bgm');
    const AC = window.AudioContext || window.webkitAudioContext;
    let ac = null;

    function startFromZero(){
      try{
        if(!isNaN(bgm.duration) && bgm.duration>0){
          if(typeof bgm.fastSeek==='function') bgm.fastSeek(0);
          bgm.currentTime = 0;
        }
      }catch(_){}
    }

    window.addEventListener('load', () => {
      bgm.pause(); startFromZero();
      bgm.muted = true;
      bgm.play().catch(()=>{});
    });

    const targets = [
      window, document, document.documentElement, document.body,
      document.getElementById('book'),
      document.getElementById('tap-left'),
      document.getElementById('tap-right')
    ].filter(Boolean);
    const events = ['pointerdown','pointerup','touchstart','touchend','click','keydown','wheel'];

    async function unlockAudio(){
      try{
        if (AC && (!ac || ac.state !== 'running')) {
          ac = ac || new AC();
          if (ac.state !== 'running') await ac.resume();
        }
        bgm.muted = false; bgm.volume = 1;
        startFromZero();
        await bgm.play();
        sessionStorage.setItem('bgmEnabled','true');
      }catch(_){}
      finally{
        events.forEach(ev => targets.forEach(t => t.removeEventListener(ev, unlockAudio, {capture:true})));
      }
    }

    if (!sessionStorage.getItem('bgmEnabled')){
      events.forEach(ev => targets.forEach(t =>
        t.addEventListener(ev, unlockAudio, { once:true, passive:true, capture:true })
      ));
    } else {
      bgm.muted=false; bgm.volume=1;
      startFromZero(); bgm.play().catch(()=>{});
    }

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && bgm.paused) { startFromZero(); bgm.play().catch(()=>{}); }
    });
    window.addEventListener('pageshow', e => {
      if (e.persisted){ bgm.pause(); startFromZero(); bgm.play().catch(()=>{}); }
    });
    bgm.addEventListener('ended', () => { startFromZero(); bgm.play().catch(()=>{}); });
  })();
  </script>

  <script>
  const PAGES = ['page1.png','page2.png','page3.png','page4.png'];
  const FLIP_MS = 700;

  (function(){
    const msg=(t)=>{const el=document.getElementById('msg'); if(el){el.textContent=t; el.style.display='block';}};

    try{
      if(!window.St || !St.PageFlip) throw new Error('PageFlip no disponible');

      const bookEl = document.getElementById('book');
      const probe = new Image();
      probe.onload = () => {
        const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
        const ratio = probe.naturalHeight / probe.naturalWidth;

        const targetCssWidth = Math.min(
          Math.floor(probe.naturalWidth / dpr),
          Math.floor(window.innerWidth * 0.98)
        );
        const targetCssHeight = Math.floor(targetCssWidth * ratio);

        const flip = new St.PageFlip(bookEl, {
          width:  targetCssWidth,
          height: targetCssHeight,
          size: "fixed",
          minWidth:  280,
          minHeight: 280,
          maxWidth:  targetCssWidth,
          maxHeight: targetCssHeight,
          usePortrait: true,
          showCover: false,
          mobileScrollSupport: false,
          flippingTime: FLIP_MS,
          drawShadow: true,
        });

        flip.loadFromImages(PAGES);
      };
      probe.onerror = () => {
        throw new Error('No se pudo leer la primera imagen');
      };
      probe.src = PAGES[0];

    }catch(e){
      console.warn(e);
      msg('Modo simple (sin efectos)');
      document.getElementById('book').style.display='none';
      const fb=document.getElementById('fallback'); if(fb){ fb.style.display='block'; }
    }
  })();
  </script>
</body>
</html>
